# Code Path Marker - 代码执行路径标记器

> 通过可视化节点图谱还原代码执行路径，辅助调试、代码审查与知识传递。
>
> [注意] 插件当前仍处于测试阶段，功能接口、文档、数据结构可能会频繁调整，欢迎反馈体验问题与改进建议。

## 项目简介

Code Path Marker 是一款 VS Code 扩展，支持在阅读或调试代码时，以交互式节点的方式记录执行路径。它通过结构化文本树帮助开发者在复杂逻辑中快速定位、追踪和分享关键代码片段。

## 核心功能地图

| 能力模块 | 亮点功能 |
| --- | --- |
| 路径标注 | 统一“Code Path”右键菜单、根/父/子/兄弟节点、文件/文件夹标注、节点复制/粘贴/剪切/排序、复制代码上下文 |
| 智能追踪 | 多策略位置匹配（精确/邻近/全文/模糊）、SHA-256 代码指纹、位置置信度评估、自动更新节点位置与片段 |
| 图谱可视化 | 文本树预览、实时刷新、分屏布局、预览面板自定义菜单、状态栏节点提示 |
| 图谱管理 | 多 Code Path 切换、自动保存与定时备份、自动加载上次图谱、图文件右键快速预览 |
| 协作分享 | 一键导出/导入 `.codepath/*.json`、导入后自动切换与定位、剪贴板图谱分享（Win/macOS）|
| 开发体验 | 命令面板 & 快捷键全覆盖、错误提示与恢复策略、配置项覆盖默认视图/性能/保存周期 |

## 典型使用场景

- **调试复杂逻辑**：在函数调用链中逐点标记执行流程，自动追踪代码位置变动。
- **代码审查/交接**：导出图谱文件，与团队共享关键路径，降低沟通成本。
- **文档与教学**：使用结构化文本记录执行路径，帮助新成员或学员理解业务流程。
- **重构与回归**：结合置信度提示，快速校验重构是否影响既有执行点。

## 系统要求

- VS Code ≥ 1.74.0
- Node.js 最新 LTS（用于本地开发/调试扩展）
- 需要打开一个工作区或文件夹

## 快速开始

### 安装扩展
1. 打开 VS Code，进入扩展市场（`Ctrl+Shift+X`）。
2. 搜索 **Code Path Marker**。
3. 点击安装，并在提示时重新加载 VS Code。

### 创建第一个执行路径
1. 选中任意代码片段，右键选择 `Code Path → Mark as New Node` 新建根节点。
2. 选中后续代码，选择 `Mark as Child Node`、`Mark as Parent Node` 或 `Mark as Bro Node` 构建层级。
3. 在左侧 Code Path 预览面板中点击节点即可跳转至对应代码，查看实时树状结构。
4. 当代码移动或修改后，点击“刷新”按钮，根据提示更新节点位置。

### 快捷键速览

| 操作 | 快捷键 | 说明 |
| --- | --- | --- |
| 打开/隐藏预览面板 | `Ctrl+Shift+C` | 切换 Code Path 预览面板 |
| 标记根节点 | `Ctrl+Alt+N` | 从选中代码创建新的根节点 |
| 标记子节点 | `Ctrl+Alt+C` | 在当前节点下创建子节点 |
| 标记父节点 | `Ctrl+Alt+P` | 在当前节点上方创建父节点 |
| 标记兄弟节点 | `Ctrl+Alt+B` | 在同一层级创建兄弟节点 |
| 切换节点 | `Ctrl+Alt+S` | 在图谱中模糊搜索并切换节点 |
| 切换 Code Path | `Ctrl+Shift+G` | 多图谱快速切换 |
| 切换视图格式 | `Ctrl+Shift+T` | 预留给后续图表格式（当前仅支持文本） |
| 刷新预览 | `Ctrl+Shift+R` | 手动刷新图谱视图与位置校验 |

更多命令可通过 `Ctrl+Shift+P` 搜索 “Code Path Marker” 查看。

## 工作流指南

### 构建与组织节点
- 首个节点自动生成图谱，后续所有节点沿当前 Code Path 维护层级关系。
- 节点名称会默认使用函数/文件信息，可在节点编辑器中修改、补充描述，支持多行文本与 Markdown 基础语法。
- 通过上下文菜单或快捷键完成复制、粘贴、剪切、上移、下移等操作，保持执行路径清晰。

### 智能位置追踪与自动更新
- Location Tracker 综合精确定位、邻近搜索、全文搜索与模糊匹配，确保代码变动后仍能找到节点。
- 每次刷新会给出 `exact/high/medium/low` 置信度提示，辅助判断更新的可靠性。
- 接受更新后，节点的文件、行号与代码片段会同步调整，预览面板即时刷新。
- 若定位失败，可选择保留原位置或使用“导航到原始位置”快速回溯。

### 图谱管理与可视化
- 通过状态栏菜单快速查看当前 Code Path、节点数量、自动保存状态。
- 支持在同一工作区维护多个图谱，切换时自动更新预览与状态栏信息。
- 文本视图提供极简树形结构并支持即时刷新。图表视图仍在开发中。
- 预览面板右键菜单支持刷新、导出、复制、粘贴、剪切、排序等高频操作，可替代浏览器默认菜单。

### 协作与分享
- 图谱数据存储在工作区 `.codepath/` 目录下，采用 JSON 格式，便于版本控制。
- 通过预览面板或命令面板一键导出当前图谱，可将图文件复制到剪贴板（Win/macOS）或直接分享路径（Linux）。
- 导入 `.codepath/*.json` 文件后，扩展会自动切换并定位至图谱的当前节点，保证协作连续性。

## 进阶能力

- **树分叉**：为已有父节点的节点增加新的父节点时自动形成分叉，支持多条执行路径并存。
- **节点批量维护**：结合节点验证规则，在大量节点更新时避免结构断裂。
- **文件/文件夹节点**：从资源管理器右键直接标记文件或文件夹，适合记录入口文件或模块目录。
- **分屏协作**：搭配 VS Code 分屏功能，将代码与预览并排显示，辅助演示或教学。
- **自动备份**：可配置自动保存间隔，扩展会在后台维护备份，防止异常退出导致数据丢失。

## 配置与自定义

常用配置项可通过 VS Code `Settings` 搜索 “Code Path Marker” 修改，部分示例如下：

| 配置键 | 默认值 | 说明 |
| --- | --- | --- |
| （内部设置）默认预览模式 | `"text"` | 当前固定为文本模式，暂不提供用户级开关 |
| `codepath.autoSave` | `true` | 是否启用自动保存 |
| `codepath.autoLoadLastGraph` | `true` | 启动时自动加载上次使用的图谱 |
| `codepath.autoOpenPreviewOnStartup` | `true` | 启动后自动弹出 CodePath 预览面板 |
| `codepath.previewRefreshInterval` | `1000` | 预览刷新间隔（毫秒），影响实时更新频率 |
| `codepath.maxNodesPerGraph` | `100` | 每个图谱的节点上限，超过会触发性能提示 |

更完整的配置说明参见 `docs/CONFIGURATION-ZH.md`。

## 数据结构与文件位置

- 图谱文件：`.codepath/*.json`，建议纳入版本控制以追踪历史。
- 备份文件：`.codepath/backups/`，按时间戳存放，可在异常时手动恢复。
- 扩展临时数据：`.codepath/tmp/`，用于导入导出的过渡数据。

## 故障排查速查表

- **提示“请先选择代码文本”**：创建节点前需选中代码，可使用 `Ctrl+L` 快速选择当前行。
- **刷新后定位失败**：检查文件是否被移动或重命名，可点击“导航到原始位置”再手动标注。
- **节点移动无效**：确认当前节点有兄弟节点，或未处于边界位置。
- **预览不刷新**：尝试 `Ctrl+Shift+R` 强制刷新，若仍失败请查看输出面板中的错误信息。
- **导入图谱无反应**：确认导入文件位于工作区内，或检查 JSON 是否被手动改动导致格式不合法。

更多问题与解决方案详见 `docs/LEARNING-GUIDE.md` 与 `docs/QUICK_REFERENCE_AUTO_UPDATE.md`。

## 常见问题（FAQ）

1. **是否支持与团队共享？** 支持。通过导出 `.codepath` 图谱文件即可在团队间分享，配合 Git 还可追踪变更历史。
2. **目前能否渲染图表？** 图表格式仍在开发中，当前预览集中在文本视图。
3. **大型图谱如何保持性能？** 建议拆分为多个 Code Path，并调低自动刷新频率；扩展会在节点数接近上限时提示优化建议。

## 深入学习

- `docs/API-ZH.md`：命令与内部模块的详细接口说明。
- `docs/AUTO_UPDATE_LOCATION_GUIDE.md`：位置自动更新的算法与使用策略。
- `docs/STATUS_BAR_MENU.md`：状态栏快捷菜单功能解析。
- `docs/change-log/`：按 Order 编号记录的演进历程，可结合 `CHANGELOG.md` 查看版本摘要。

## 贡献与社区

- 阅读 `docs/CONTRIBUTING-ZH.md` 了解开发流程与代码规范。
- 完整测试策略参考 `TEST_REPORT.md` 与 `FINAL_TEST_SUMMARY.md`。
- 欢迎通过 Issues / Discussions 反馈建议或提交 Pull Request。

## 许可

本项目基于 MIT 许可，详见仓库根目录 `LICENSE`。

## 支持渠道

- 问题反馈：<https://github.com/your-org/codepath-extension/issues>
- 讨论交流：<https://github.com/your-org/codepath-extension/discussions>
- 交互式文档：`docs/index.html`

---

**祝你享受可视化代码路径的高效体验！**
