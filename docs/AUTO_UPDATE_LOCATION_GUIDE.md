# 自动更新节点位置 - 用户指南

## 功能介绍

当你的代码发生变化（例如添加或删除了几行代码），CodePath会智能地检测到节点位置的变化，并提示你更新。

## 使用场景

### 场景1：代码行号发生变化

你在文件中添加了几行代码：

```typescript
// 原来的代码在第10行
function hello() {
    console.log("Hello");
}

// 你在上面添加了注释
// 现在这个函数在第12行了
```

当你点击CodePath中的节点时，系统会提示：

```
⚠️ Code location may have changed: Code found at line 12 (moved 2 lines)
[OK] [Dismiss]
```

### 场景2：代码被移动到其他位置

你重构了代码，将函数移动到了文件的其他位置。系统会智能搜索并找到新位置。

## 操作步骤

### 1. 点击节点

在CodePath预览面板中点击任意节点，系统会尝试导航到对应的代码位置。

### 2. 查看提示

如果代码位置发生了变化，会弹出警告消息：

```
Code location may have changed: Code found at line 124 (moved 2 lines)
```

消息会告诉你：
- 代码在新位置被找到
- 移动了多少行

### 3. 选择操作

你有两个选择：

#### 点击 "OK"
- ✅ 自动更新节点位置到新的行号
- ✅ 更新代码片段
- ✅ 保存更改
- ✅ 显示成功消息："Node location updated successfully"

#### 点击 "Dismiss"
- ❌ 保持原有位置不变
- ❌ 不做任何更新
- ℹ️ 下次点击节点时仍会显示相同提示

## 智能搜索

系统使用多种策略来找到移动的代码：

### 1. 精确匹配
使用代码指纹（哈希值）进行精确匹配，确保找到的是同一段代码。

### 2. 邻近搜索
首先在原位置附近（前后20行）搜索，因为代码通常不会移动太远。

### 3. 全文搜索
如果邻近搜索失败，会搜索整个文件。

### 4. 模糊匹配
使用相似度算法，即使代码有轻微修改也能找到。

## 置信度说明

系统会根据匹配质量显示不同的置信度：

| 置信度 | 说明 | 建议 |
|--------|------|------|
| **Exact** | 精确匹配，代码完全相同 | 放心更新 |
| **High** | 高置信度，相似度>95%或距离≤5行 | 建议更新 |
| **Medium** | 中等置信度，相似度>85%或距离≤10行 | 检查后更新 |
| **Low** | 低置信度，相似度>80% | 谨慎更新 |
| **Failed** | 未找到匹配 | 不显示更新选项 |

## 注意事项

### ✅ 推荐做法

1. **及时更新**：当提示出现时，及时点击"OK"更新位置
2. **验证代码**：更新后检查导航是否正确
3. **保持同步**：定期更新所有节点位置

### ⚠️ 注意事项

1. **重大重构**：如果进行了大规模代码重构，建议手动检查所有节点
2. **文件重命名**：如果文件被重命名或移动，需要手动更新节点
3. **代码删除**：如果代码被完全删除，系统无法找到新位置

### ❌ 避免的情况

1. **不要忽略提示**：长期忽略提示会导致节点位置越来越不准确
2. **不要在重构时删除节点**：先更新位置，再决定是否删除节点

## 常见问题

### Q: 为什么有时候找不到代码？

A: 可能的原因：
- 代码被完全删除或重写
- 代码被移动到其他文件
- 代码修改太大，相似度低于阈值

### Q: 更新后位置还是不对怎么办？

A: 可以手动更新节点：
1. 右键点击节点
2. 选择"Edit Node"
3. 手动修改文件路径和行号

### Q: 可以批量更新多个节点吗？

A: 目前不支持批量更新，需要逐个更新。这个功能在未来版本中会添加。

### Q: 可以撤销更新吗？

A: 目前不支持撤销。建议在更新前确认位置是否正确。

### Q: 更新会影响子节点吗？

A: 不会。每个节点的位置是独立的，更新父节点不会影响子节点。

## 技术细节

### 代码指纹

系统为每段代码生成一个SHA-256哈希值（取前16位），用于精确匹配：

```typescript
// 示例代码
const test = 1;

// 生成的哈希（示例）
codeHash: "a3f5b2c8d1e4f6a7"
```

### 相似度计算

使用Levenshtein距离算法计算代码相似度：

```
相似度 = 1 - (编辑距离 / 最大长度)
```

### 搜索范围

- **邻近搜索**：原位置 ± 20行
- **全文搜索**：整个文件（如果邻近搜索失败）

## 反馈与建议

如果你遇到问题或有改进建议，欢迎：
- 提交Issue
- 发送反馈
- 贡献代码

## 相关文档

- [位置跟踪技术文档](../AUTO_UPDATE_NODE_LOCATION.md)
- [节点管理指南](./NODE_MANAGEMENT.md)
- [智能导航功能](./INTELLIGENT_NAVIGATION.md)
