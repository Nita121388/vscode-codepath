# 更新日志

本文件将记录 CodePath 扩展的所有重要变更。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
并且本项目遵循[语义化版本控制](https://semver.org/lang/zh-CN/)。

## [未发布]

## [0.2.1] - 2025-10-19

### 新增
- 新增 `codepath.autoOpenPreviewOnStartup` 设置项，可在加载上次图谱后决定是否自动展开预览面板。

### 变更
- 状态栏快捷菜单将“刷新预览”调整为“👁️ 刷新和预览”，刷新时会在面板隐藏时自动激活预览。
- 预览视图快捷菜单新增“⚙️ 打开设置”入口，并优化粘贴命令的图标提示，提高配置入口的可发现性。

### 修复
- 手动刷新流程统一复用可见性检测，确保强制刷新在主面板与侧边栏中都能稳定渲染最新内容。

## [0.2.0] - 2025-10-16

### 新增
- 初始发布准备
- 包含 575+ 测试的全面测试套件
- 性能监控与优化
- 跨平台兼容性测试
- 启动时若图谱有节点则自动打开预览面板
- **菜单结构重构** - 统一菜单结构的完整 UI 大修
  - 插件显示名称从 "Code Path Wormhole" 更改为 "Code Path Marker"
  - 所有命令移至统一的 "Code Path" 子菜单
  - 命令标题更新："New" → "Mark as"（例如，"Mark as New Node"）
  - 保留所有现有键盘快捷键和功能
  - 通过逻辑分组增强菜单组织
- **文件/文件夹上下文支持** - 直接从文件资源管理器创建节点
  - 在资源管理器中右键单击任何文件或文件夹以创建节点
  - 自动使用文件/文件夹名作为节点名称
  - 自动路径解析和行号处理
  - 与现有节点创建工作流的无缝集成
- **节点复制/粘贴/剪切操作** - 高级节点操作功能
  - 将节点及其所有子节点复制到剪贴板
  - 剪切节点以将其移动到新位置
  - 粘贴节点树并自动生成 ID
  - 深度复制功能保留完整的节点结构
  - 支持跨图谱粘贴
- **节点顺序管理** - 调整节点在同级节点中的位置
  - 在同一父级级别内上移/下移节点
  - 智能边界检测并提供用户友好的消息
  - 重新排序后自动刷新预览
  - 支持根节点和子节点
- **预览界面自定义菜单** - 增强的预览交互
  - 预览面板中的自定义右键菜单
  - 上下文相关的菜单选项（刷新、导出、复制、粘贴、剪切、上移、下移）
  - 替换默认的浏览器上下文菜单
  - 与命令系统直接集成
- **创建兄弟节点功能** - 在与当前节点同一级别创建兄弟节点
  - 通过右键上下文菜单集成 "Mark as Bro Node" 选项
  - 键盘快捷键 `Ctrl+Alt+B` 用于快速访问
  - 命令面板支持 "Code Path Marker: Mark as Bro Node" 命令
  - 智能关系处理：创建父节点的子节点或新的根节点
  - 从选定文本自动捕获代码
  - 与现有节点创建工作流的无缝集成
- **状态栏快速菜单** - 单击状态栏可访问所有图谱管理功能
  - 创建新图谱
  - 在图谱之间切换
  - 导出/导入图谱
  - 删除图谱
  - 刷新预览
  - 切换节点
  - 切换视图格式
- 增强的状态栏工具提示，带有丰富的 Markdown 格式
- **自动切换到新图谱** - 新创建的图谱自动设置为活动状态，并完全更新 UI
- **树分叉功能** - 当为已有父节点的节点添加新父节点时，创建树分叉以保留两种关系
  - 保留原始的父子关系
  - 新父节点创建一个带有重复节点的独立分支
  - 所有后代节点都转移到新分支
  - 支持跟踪同一代码位置的多个执行路径
- **自动更新节点位置** - 当代码位置发生变化时，系统提示用户更新节点位置
  - 智能代码搜索，具有多种策略（精确匹配、附近搜索、全文搜索）
  - 用户确认对话框，带有 "确定" 和 "忽略" 选项
  - 确认后自动更新节点位置、行号和代码片段
  - **立即预览刷新** - 点击确定后预览立即更新，无需切换节点
  - 置信度级别（精确、高、中、低）以指示匹配质量
  - 使用 SHA-256 哈希进行代码指纹识别以实现精确跟踪
  - 使用 Levenshtein 距离进行模糊匹配以处理修改后的代码

### 修复
- 节点位置更新后预览未立即更新 - 现在立即刷新并显示最新数据
- 不同上下文下菜单结构不一致的问题
- 命令注册和上下文处理的改进
- 针对新剪贴板和顺序操作的增强错误处理

### 技术实现
- **新的管理器类**
  - `ClipboardManager`：处理节点复制/粘贴/剪切操作，支持深度树复制
  - `NodeOrderManager`：管理兄弟节点排序，具有边界检测功能
  - 增强的 `CommandManager`：将新操作与现有工作流集成
  - 扩展的 `WebviewManager`：为预览实现自定义上下文菜单
- **数据模型扩展**
  - 用于剪贴板操作的 `ClipboardData` 接口
  - 用于分层节点复制的 `NodeTreeData` 接口
  - 扩展的 `Graph` 接口，支持节点排序
  - 用于剪贴板和顺序操作的新错误类型
- **菜单系统重新设计**
  - 具有逻辑分组的子菜单结构
  - 上下文相关的菜单项显示
  - 增强的命令注册，具有适当的分类
  - 文件资源管理器集成，具有资源上下文检测
- **增强的错误处理**
  - 用于剪贴板和顺序操作的新错误类别
  - 用户友好的错误消息，带有恢复建议
  - 针对边缘情况的优雅降级
  - 对所有新操作的全面验证

### 变更
- **插件身份更新** - 完全重新命名以提高清晰度
  - 显示名称："Code Path Wormhole" → "Code Path Marker"
  - 命令类别："CodePath" → "Code Path Marker"
  - 所有面向用户的文本更新以反映 "标记" 概念
  - 文档更新，采用新的命名约定
- **菜单结构大修** - 统一且有条理的菜单系统
  - 所有 CodePath 命令现在位于 "Code Path" 子菜单下
  - 逻辑分组：创建 (1_create)、编辑 (2_edit)、排序 (3_order)、文件 (4_file)
  - 基于上下文的条件性菜单项显示
  - 增强的菜单项描述和组织
- **命令命名约定** - 更直观的命令名称
  - "New Node" → "Mark as New Node"
  - "New Child Node" → "Mark as Child Node"
  - "New Parent Node" → "Mark as Parent Node"
  - "New Bro Node" → "Mark as Bro Node"
  - 所有成功消息更新为使用 "标记为" 术语
- **增强的用户反馈** - 改进的消息系统
  - 成功消息使用 "标记为" 而不是 "创建"
  - 错误消息引用更新后的命令名称
  - 整个扩展中一致的术语
- 改进的错误处理和恢复机制
- 针对大型图谱优化内存使用
- 当加载具有现有节点的图谱时，预览面板现在自动打开
- 简化的状态栏，仅显示图谱信息（移除节点和预览状态项）
- **简化的文件路径显示** - 在预览中仅显示文件名而不是完整路径（完整路径仍用于导航）

### 修复
- 节点创建同步问题
- 预览格式切换可靠性
- 扩展激活顺序
- VS Code 启动时若图谱已加载，预览面板未自动打开的问题
- 启动时预览面板显示空内容（现在正确显示加载的图谱）
- 启动时状态栏未显示当前图谱信息（现在自动更新）

## [0.1.0] - 2025-10-01

### 新增
- **核心功能**
  - 从选定文本交互式创建代码路径节点
  - 右键上下文菜单集成
  - 分层父子节点关系
  - 智能节点导航与模糊匹配
  - 基于位置的精确节点匹配

- **可视化**
  - 基于文本的分层图谱表示
  - 实时预览更新
  - 分屏布局（代码 + 预览）
  - 在文本和图表之间切换格式

- **图谱管理**
  - 支持多图谱切换
  - 图谱创建、加载和保存
  - Markdown 导出/导入功能
  - 可配置间隔的自动保存
  - 备份和恢复系统

- **用户界面**
  - 状态栏集成，显示当前图谱/节点
  - 命令面板集成，支持所有操作
  - 常用操作的键盘快捷键
  - 用于预览显示的 Webview 面板
  - 上下文相关的菜单项

- **配置**
  - 默认视图格式设置（文本视图）
  - 启用/禁用自动保存
  - 启动时自动加载最后一个图谱
  - 预览刷新间隔配置
  - 每个图谱的最大节点数限制

- **开发者体验**
  - 全面的错误处理，提供用户友好的消息
  - 渲染失败时的优雅降级
  - 针对大型图谱的性能监控
  - 内存使用优化
  - 跨平台文件路径处理

- **存储与持久化**
  - 基于工作区的存储，位于 `.codepath/` 目录
  - 基于 JSON 的图谱文件格式
  - 自动创建备份
  - 损坏文件恢复
  - Git 友好的存储结构

### 技术实现

- **架构**
  - 模型-视图-控制器 (MVC) 模式
  - 管理器类的依赖注入
  - 组件间的事件驱动更新
  - 正确的资源释放和内存管理

- **核心管理器**
  - `GraphManager`：图谱生命周期和操作
  - `NodeManager`：节点创建和关系管理
  - `PreviewManager`：渲染和格式管理
  - `StorageManager`：文件系统操作和持久化
  - `ConfigurationManager`：设置和偏好
  - `StatusBarManager`：状态栏集成
  - `WebviewManager`：预览面板管理
  - `CommandManager`：命令注册和处理
  - `IntegrationManager`：组件协调

- **数据模型**
  - `Graph`：具有验证功能的图谱数据结构
  - `Node`：具有关系管理的节点模型
  - 所有数据结构都有类型安全的接口
  - 全面的输入验证

- **渲染系统**
  - `TextRenderer`：分层文本表示
  - 渲染失败时的回退机制
  - 针对大型图谱的性能优化

- **错误处理**
  - 自定义的 `CodePathError` 类，具有分类功能
  - 恢复操作建议
  - 优雅降级策略
  - 用户友好的错误消息

### 测试

- **全面测试套件**
  - 总计 575+ 测试，通过率 91.2%
  - 所有核心组件的单元测试
  - 端到端工作流的集成测试
  - 可扩展性的性能测试
  - 健壮性的边缘情况测试
  - 跨平台兼容性测试

- **测试类别**
  - 需求验证测试
  - 错误处理和恢复测试
  - 性能和内存使用测试
  - 并发和竞态条件测试
  - 文件系统和存储测试
  - UI 集成测试

### 性能特征

- **可扩展性**
  - 推荐限制：每个图谱 100 个节点
  - 测试高达 200 个节点，性能可接受
  - 针对大型图谱的分段加载
  - 预览渲染的 5 秒超时

- **内存使用**
  - 基础扩展：~10MB
  - 100 节点图谱：~25MB
  - 增长率：每个节点 ~150KB
  - 自动内存监控

- **操作性能**
  - 节点创建：平均 ~50ms
  - 图谱切换：平均 ~100ms
  - 预览更新：平均 ~200ms（文本视图）
  - 导出/导入：中等图谱约 ~1s

### 已知问题

- 某些子节点创建的边缘情况可能失败（竞态条件）
- 扩展激活顺序需要优化
- 错误恢复机制需要增强

### 开发工具

- **构建系统**
  - 严格模式的 TypeScript 编译
  - ESLint 用于代码质量
  - Vitest 作为测试框架
  - VS Code 扩展开发工具

- **开发工作流**
  - 开发期间的热重载
  - 全面的调试支持
  - 扩展开发主机集成
  - 自动化测试流水线

### 文档

- 包含使用示例的全面 README
- 面向开发者的贡献指南
- 所有公共接口的 API 文档
- 常见问题的故障排除指南
- 性能优化建议

---

## 发布说明格式

### 新增
- 新功能和能力

### 变更
- 现有功能的变更

### 已弃用
- 将在未来版本中移除的功能

### 已移除
- 已移除的功能

### 修复
- 错误修复和更正

### 安全
- 安全相关的改进

---

*有关详细的技术信息，请参阅[技术文档](docs/)和[API 参考](docs/api/)。*
